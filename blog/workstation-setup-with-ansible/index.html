<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <script defer data-domain="schfkt.dev" src="https://a.schfkt.dev/js/script.js"></script>

  <title>Automate workstation setup with Ansible</title>

  <link href="//fonts.googleapis.com/css?family=Open+Sans&subset=latin,cyrillic" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="/css/bundle.css">
</head>


<body>
  <div class="bg-primary">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-12 col-lg-10 px-0">
        <nav class="py-2 justify-content-start">
            <ul class="nav">
              <li class="nav-item">
                <a class="nav-link text-light" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-light" href="/blog">Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-light" href="/about">About</a>
              </li>
            </ul>
        </nav>
      </div>
    </div>
  </div>
</div>


  <div class="container">
    <div class="row justify-content-center pb-5 pt-4">
      <div class="col-md-12 col-lg-10">
        

<article class="post">
  <div class="post-header">
    <h1 class="post-title">Automate workstation setup with Ansible</h1>
    <div class="post-meta">May 13, 2023</div>
    <div class="post-meta">7 minutes to read</div>
  </div>

  <p>Since the early days of my software engineering career I was trying different ways to automate setup of my workstations. The first attempt that served me well, but was quite basic, included just a github repo with all my dotfiles plus a bash script to automate symlinking of these configs. Package instalation and some other tweaking were still done manually, although in case of macOS it was easy thanks to Brewfile with all the packages I needed.</p>
<p>Then a few years later I had to play with Ansible at work. I liked its simplicity and quickly realized: why not just use it to setup my machines? It was especially important at that time, because I was using both macos and linux setups. And both of the systems had specific setup steps that I, of course, could add into the bash script, but it would quickly become tedious.</p>
<p>After maybe a year of using Ansible at work and for my homelab setup I decided to try it also to configure my machines. It turned out to be great! In case I need to setup a new workstation now, it&rsquo;ll just take me around 15 minutes to replicate the same setup that I have everywhere. With the same dotfiles I use, which are synced across all the machines thanks to <a href="https://syncthing.net/">syncthing</a> (this is another great tool that deserves its own blogpost!).</p>
<h1 id="ansible-101">Ansible 101</h1>
<p>Ansible consists of many interesting features, but the one you are gonna use the most is a playbook. A playbook describes what has to be done on a list of hosts. For example: installing packages, copying config files, configuring a firewall. For each such kind of task, there&rsquo;s a module responsible for it. A module is a Python library that implements that functionality. Some modules are bultin into most of the Ansible installations. And there are plenty of them. Every time I want to do something new with Ansible, I find a module for that.</p>
<p>Here are a couple of examples:</p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/authorized_key_module.html">authorized_key</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/ufw_module.html">ufw</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html">template</a></li>
</ul>
<p>I think, template module is the one that I use the most. It allows to use <a href="http://jinja.pocoo.org/docs/">jinja2 templating engine</a> to build files based on, well, templates. When some config file requires configurability (by substituting certain variables), this is the module to go for.</p>
<p>Below is a basic example of a playbook:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">setup smarthome server</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">smarthome</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">disks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">uuid</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;b041aa26-a64b-47c5-922a-84d2102bca24&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">fstype</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mount disks</span><span class="w">
</span><span class="w">      </span><span class="nt">ansible.posix.mount</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;UUID={{item.uuid}}&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/srv</span><span class="w">
</span><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">mounted</span><span class="w">
</span><span class="w">        </span><span class="nt">fstype</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.fstype }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">disks</span><span class="w">
</span><span class="w">      </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ disks }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: sshd, tags</span><span class="p">:</span><span class="w"> </span><span class="l">sshd }</span><span class="w">
</span></code></pre></div><p>Each playbook contains an array of so-called &ldquo;plays&rdquo;. A &ldquo;play&rdquo; is just a list of tasks applied to a list of hosts. That particular playbook has only one &ldquo;play&rdquo; with:</p>
<ul>
<li>List of hosts to apply tasks to. Here we have only one host: <code>smarthome</code>.</li>
<li><code>become: true</code> tells Ansible that all the tasks has to be run as <code>root</code> (can be changed with <code>become_user</code> too).</li>
<li>Variables definitions. These can later be used in tasks or for substitutions in templates.</li>
<li>Individual tasks to apply to hosts.</li>
<li>List of roles to apply to hosts (more on roles below).</li>
</ul>
<p>This is just a high-level overview of what a playbook can look like. For more information, please refer to the docs: <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html</a></p>
<p>Sometimes, when you want to extract related tasks out of a playbook, there&rsquo;s also a way to do this. Roles are used just for that. A role is a set of tasks and configurations. It&rsquo;s just a way to share some tasks as a whole unit. And Ansible also allows to distribute it like packages through Ansible Galaxy. There are a lot of great roles made by the community, like a role for nginx, grafana, etc. In my configuration for workstations, I use roles to group related tasks and apply them separately when needed. For example, I have a role for nvim that installs and configures nvim together with plugins and external tools needed for them.</p>
<p>You can read more about roles in the official docs here: <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html</a></p>
<p>And there is much more to cover about Ansible, but for this guide, this should be enough.</p>
<h1 id="practical-example">Practical example</h1>
<blockquote>
<p><strong>NOTE:</strong> refer to this repository for the most up-to-date version of the setup described here <a href="https://github.com/schfkt/ansible-workstation">https://github.com/schfkt/ansible-workstation</a></p>
</blockquote>
<p>Let&rsquo;s get to a real-world example of how everything I mentioned above can be used to set up a machine. Here&rsquo;s the playbook I use:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">dotfiles_dir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ lookup(&#39;env&#39;, &#39;HOME&#39;) }}/sync/df&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: packages, tags</span><span class="p">:</span><span class="w"> </span><span class="l">packages }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: alacritty, tags</span><span class="p">:</span><span class="w"> </span><span class="l">alacritty }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: vim, tags</span><span class="p">:</span><span class="w"> </span><span class="l">vim }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: nvim, tags</span><span class="p">:</span><span class="w"> </span><span class="l">nvim }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: tmux, tags</span><span class="p">:</span><span class="w"> </span><span class="l">tmux }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: tig, tags</span><span class="p">:</span><span class="w"> </span><span class="l">tig }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: bash, tags</span><span class="p">:</span><span class="w"> </span><span class="l">bash }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: i3, tags</span><span class="p">:</span><span class="w"> </span><span class="l">i3 }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: hibernate, tags</span><span class="p">:</span><span class="w"> </span><span class="l">hibernate }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: firewall, tags</span><span class="p">:</span><span class="w"> </span><span class="l">firewall }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: nodejs, tags</span><span class="p">:</span><span class="w"> </span><span class="l">nodejs }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: gpg, tags</span><span class="p">:</span><span class="w"> </span><span class="l">gpg }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: tailscale, tags</span><span class="p">:</span><span class="w"> </span><span class="l">tailscale }</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">role: syncthing, tags</span><span class="p">:</span><span class="w"> </span><span class="l">syncthing }</span><span class="w">
</span></code></pre></div><p>It&rsquo;s quite basic and consists of:</p>
<ul>
<li>A global variable <code>dotfiles_dir</code> that can be used later in the roles/tasks to create symlinks to config files. That way I don&rsquo;t have to duplicate this value everywhere.</li>
<li>A list of roles.</li>
</ul>
<p>And that&rsquo;s it. As you can see, it&rsquo;s mostly split into separate parts by using roles. Most of the roles here describe how a particular tool has to be set up. Except for the <code>packages</code> role that just contains the list of packages to install (with brew or apt).</p>
<p>Because I use both macOS and Linux, each role may contain steps specific to each OS. And this can also be easily achieved with Ansible. Let&rsquo;s look at the role for <code>Neovim</code>. Here&rsquo;s its structure:</p>
<pre tabindex="0"><code>$ tree roles/nvim/
roles/nvim/
└── tasks
    ├── main.yml
    └── packages
        ├── macos.yml
        ├── main.yml
        └── ubuntu.yml
</code></pre><p>And the entrypoint <code>tasks/main.yml</code> looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install required packages</span><span class="w">
</span><span class="w">  </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">packages/main.yml</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create directories for nvim</span><span class="w">
</span><span class="w">  </span><span class="nt">file</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">directory</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;~/.config&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;~/.local/share/nvim/site/autoload&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;~/.local/share/nvim/undo&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;~/.local/share/nvim/backup&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;~/.local/share/nvim/swap&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install vim-plug</span><span class="w">
</span><span class="w">  </span><span class="nt">get_url</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;~/.local/share/nvim/site/autoload/plug.vim&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="m">0600</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">link the configs</span><span class="w">
</span><span class="w">  </span><span class="nt">file</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ dotfiles_dir }}/{{ item.src }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.dest }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">link</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- {<span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.config/nvim&#34;</span><span class="nt">, dest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;~/.config/nvim&#34;</span>}<span class="w">
</span><span class="w">    </span>- {<span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.vim/ultisnips&#34;</span><span class="nt">, dest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;~/.local/share/nvim/ultisnips&#34;</span>}<span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install the plugins</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;nvim -E -s -c &#34;source ~/.config/nvim/init.vim&#34; -c PlugInstall -c qa&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">compile YCM</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">chdir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;~/.local/share/nvim/plugged/YouCompleteMe&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;./install.py --clang-completer --go-completer --ts-completer --rust-completer&#34;</span><span class="w">
</span></code></pre></div><p>It&rsquo;s pretty self-descriptive: it creates config directories, installs everything related to neovim, and makes symlinks to configs.</p>
<p>All of the tasks, except the first one, are the same for macOS and Linux. But the first task includes tasks from another file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install packages for PopOS</span><span class="w">
</span><span class="w">  </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_distribution == &#39;Pop!_OS&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install packages for macOS</span><span class="w">
</span><span class="w">  </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">macos.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_distribution == &#39;MacOSX&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install package for python plugins support</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;python3 -m pip install --user --upgrade pynvim&#34;</span><span class="w">
</span></code></pre></div><p>And here goes the &ldquo;magic&rdquo;: it conditionally includes OS-specific tasks based on the value of <code>ansible_distribution</code> variable (which is populated by Ansible). So for Linux it does this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install prerequisites for PPA</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">apt</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">software-properties-common</span><span class="w">
</span><span class="w">    </span><span class="nt">install_recommends</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add PPA repo</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">apt_repository</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;ppa:neovim-ppa/stable&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install packages for YCM</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">apt</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">python3-dev</span><span class="w">
</span><span class="w">      </span>- <span class="l">python3-pip</span><span class="w">
</span><span class="w">      </span>- <span class="l">build-essential</span><span class="w">
</span><span class="w">      </span>- <span class="l">cmake</span><span class="w">
</span><span class="w">      </span>- <span class="l">golang</span><span class="w">
</span><span class="w">      </span>- <span class="l">nodejs</span><span class="w">
</span><span class="w">      </span>- <span class="l">npm</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install neovim</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">apt</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">neovim</span><span class="w">
</span><span class="w">    </span><span class="nt">install_recommends</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install additional packages</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">apt</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">fzf</span><span class="w">
</span><span class="w">      </span>- <span class="l">ripgrep</span><span class="w">
</span><span class="w">    </span><span class="nt">install_recommends</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></code></pre></div><p>And for macOS this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install packages for YCM</span><span class="w">
</span><span class="w">  </span><span class="nt">homebrew</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">cmake</span><span class="w">
</span><span class="w">      </span>- <span class="l">golang</span><span class="w">
</span><span class="w">      </span>- <span class="l">nodejs</span><span class="w">
</span><span class="w">      </span>- <span class="l">rustup-init</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install nvim</span><span class="w">
</span><span class="w">  </span><span class="nt">homebrew</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nvim</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install additional packages</span><span class="w">
</span><span class="w">  </span><span class="nt">homebrew</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">fzf</span><span class="w">
</span><span class="w">      </span>- <span class="l">ripgrep</span><span class="w">
</span></code></pre></div><p>So that single role can configure Neovim for both macOS and Linux based machines.</p>
<p>And now that we&rsquo;ve got the playbook with tasks and roles set, how do we run it to apply changes on a machine? Here you go:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">ansible-playbook --ask-become-pass playbook.yml
</code></pre></div><p><code>--ask-become-pass</code> tells Ansible to ask for a user password upfront (it&rsquo;s used to invoke <code>sudo</code> in tasks that have <code>become: true</code> set).</p>
<p>There&rsquo;s also a way to apply only specific tasks or roles. You can do so by passing a list of tags, and Ansible will filter out only roles and tasks that have these tags set. Looking at this part of the playbook:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- {<span class="w"> </span><span class="nt">role: packages, tags</span><span class="p">:</span><span class="w"> </span><span class="l">packages }</span><span class="w">
</span><span class="w">  </span>- {<span class="w"> </span><span class="nt">role: alacritty, tags</span><span class="p">:</span><span class="w"> </span><span class="l">alacritty }</span><span class="w">
</span></code></pre></div><p>You can tell Ansible to apply only <code>alacritty</code> role like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">ansible-playbook --ask-become-pass -t alacritty playbook.yml</span><span class="w">
</span></code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>It takes time to familiarise with Ansible, but it&rsquo;s much more powerful for setting up machines compared to a bunch of bash scripts. Moreover, lots of features are already present as modules, so you don&rsquo;t need to reinvent the wheel.</p>
<p>Anyway, It was a short, but hopefully useful introduction to Ansible.</p>

</article>


      </div>
    </div>
  </div>
</body>

</html>
